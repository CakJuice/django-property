{% extends 'main_layout.html' %}

{% block title %}Create Mail{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Email</h3>
                    <form method="POST" novalidate>
                        {% csrf_token %}
                        {% include 'includes/form.html' %}
                        <input type="file" id="file_attachment" name="attachment" class="hidden">
                        <div class="form-group">
                            <div class="row">
                                <div class="col-sm-4">
                                    <button type="button" class="btn btn-success" id="btn_mail_attachment">Add Attachment</button>
                                </div>
                                <div class="col-sm-8">
                                    <div class="progress hidden" id="progress-container">
                                        <div class="progress-bar" id="progress-bar" role="progressbar" style="width: 0"
                                             aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="form-group" id="attachment-container"></div>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_script %}
    <script type="text/javascript">
        var isUpload = false;

        function appendAttachment(data) {
            var attachmentUI = `<div class="col-sm-6">${data.name}</div>`;
            $('#attachment-container').append(attachmentUI);
        }

        function progressStart() {
            progressRun(0);
            $('#progress-container').show();
        }

        function progressDone() {
            isUpload = false;
            setTimeout(function() {
                if (!isUpload) {
                    $('#progress-container').fadeOut(500);
                    isUpload = false;
                }
            }, 800);
        }

        function progressRun(value) {
            $('#progress-bar').css('width', `${value}%`);
            $('#progress-bar').prop('aria-valuenow', value);
        }

        $(function() {
            $('#btn_mail_attachment').click(function() {
                $('#file_attachment').click();
            });

            $('#file_attachment').change(function() {
                if ($('#progress-container').hasClass('hidden')) {
                    $('#progress-container').removeClass('hidden');
                }
                var fileInput = $(this);
                var formData = new FormData();
                formData.append('name', this.files[0].name);
                formData.append('attachment', this.files[0]);
                progressStart();
                isUpload = true;
                $.ajax({
                    method: 'POST',
                    url: "{% url 'attachment_create' %}",
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    data: formData,
                    xhr: function() {
                        var jqXHR = null;
                        if (window.ActiveXObject) {
                            jqXHR = new window.ActiveXObject('Microsoft.XMLHTTP');
                        } else {
                            jqXHR = new window.XMLHttpRequest();
                        }

                        // upload progress
                        jqXHR.upload.addEventListener('progress', function(event) {
                            if (event.lengthComputable) {
                                var percentComplete = Math.round((event.loaded * 100) / event.total);
                                progressRun(percentComplete);
                            }
                        }, false);

                        return jqXHR;
                    },
                }).done(function(response) {
                    fileInput.val(null);
                    progressDone();
                    appendAttachment(response);
                });
            });

            $('#id_body').trumbowyg({
                btns: [
                    ['viewHTML'],
                    ['undo', 'redo'], // Only supported in Blink browsers
                    ['strong', 'em', 'del'],
                    ['superscript', 'subscript'],
                ]
            });
        });
    </script>
{% endblock %}
