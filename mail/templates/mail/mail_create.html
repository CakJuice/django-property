{% extends 'main_layout.html' %}

{% block title %}Create Mail{% endblock %}

{% block content %}
    <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12">
            <div class="card">
                <div class="card-body">
                    <h3 class="card-title">Email</h3>
                    <form method="POST" novalidate>
                        {% csrf_token %}
                        {% include 'includes/form.html' %}
                        <input type="file" id="file_attachment" name="attachment" class="hidden">
                        <div class="form-group">
                            <button type="button" class="btn btn-success" id="btn_mail_attachment">Add Attachment</button>
                        </div>
                        <div class="form-group" id="attachment-container"></div>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_script %}
    <script type="text/javascript">
        var attachmentIdx = 0;

        function appendAttachment() {
            var attachmentUI = getAttachmentContainer();
            $('#attachment-container').append(attachmentUI);
        }

        function getAttachmentContainer() {
            var attachmentUI = `
            <div class="row">
                <div class="col-sm-9" id="attachment-info-${attachmentIdx}"></div>
                <div class="col-sm-3">
                    <div class="progress" id="progress-container-${attachmentIdx}">
                        <div class="progress-bar" id="progress-bar-${attachmentIdx}" role="progressbar" style="width: 0"
                            aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>
            </div>`;
            return attachmentUI;
        }

        function progressDone(progressContainer) {
            setTimeout(function() {
                progressContainer.fadeOut(500);
            }, 800);
        }

        function progressRun(progressBar, value) {
            progressBar.css('width', `${value}%`);
            progressBar.prop('aria-valuenow', value);
        }

        $(function() {
            $('#id_body').trumbowyg({
                btns: [
                    ['viewHTML'],
                    ['undo', 'redo'], // Only supported in Blink browsers
                    ['strong', 'em', 'del'],
                    ['superscript', 'subscript'],
                ]
            });

            $('#btn_mail_attachment').click(function() {
                $('#file_attachment').click();
            });

            $('#file_attachment').change(function() {
                var formData = new FormData();
                formData.append('name', this.files[0].name);
                formData.append('attachment', this.files[0]);

                var fileInput = $(this);
                appendAttachment();
                
                fileInput.attachmentIdx = attachmentIdx;
                fileInput.attachmentInfo = $(`#attachment-info-${attachmentIdx}`);
                fileInput.progressContainer = $(`#progress-container-${attachmentIdx}`);
                fileInput.progressBar = $(`#progress-bar-${attachmentIdx}`);
                fileInput.attachmentInfo.append(this.files[0].name);
                
                attachmentIdx++;
                
                $.ajax({
                    method: 'POST',
                    url: "{% url 'attachment_create' %}",
                    contentType: false,
                    processData: false,
                    dataType: 'json',
                    data: formData,
                    xhr: function() {
                        var jqXHR = null;
                        if (window.ActiveXObject) {
                            jqXHR = new window.ActiveXObject('Microsoft.XMLHTTP');
                        } else {
                            jqXHR = new window.XMLHttpRequest();
                        }

                        // upload progress
                        jqXHR.upload.addEventListener('progress', function(event) {
                            if (event.lengthComputable) {
                                var percentComplete = Math.round((event.loaded * 100) / event.total);
                                progressRun(fileInput.progressBar, percentComplete);
                            }
                        }, false);

                        return jqXHR;
                    },
                }).done(function(response) {
                    fileInput.val(null);
                    progressDone(fileInput.progressContainer);
                });
            });
        });
    </script>
{% endblock %}
